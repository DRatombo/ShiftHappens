<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Budget Buddy</title>
    <link href="./styles.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
</head>
<body class="bg-gradient-to-br from-primary-50 to-secondary-50 min-h-screen navbar-fixed">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">
                <div class="text-2xl">üí∞</div>
                Budget Buddy
            </a>
            <div class="navbar-nav">
                <a href="/dashboard" class="navbar-link active">Dashboard</a>
                <a href="/income" class="navbar-link">Income</a>
                <a href="/savings-goals" class="navbar-link">Savings Goals</a>
                <a href="/expenses" class="navbar-link">Expenses</a>
                <a href="/rewards-center" class="navbar-link">Rewards</a>
                <a href="/profile" class="navbar-link">Profile</a>
                <button id="logoutBtn" class="navbar-link">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-gray-200" style="margin-top: 4rem;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-3">
                    <a href="/" class="flex items-center space-x-3">
                        <div class="text-3xl">üí∞</div>
                        <h1 class="text-2xl font-bold text-gradient">Budget Buddy</h1>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-gray-600"></span>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">XP:</span>
                        <span id="totalXP" class="font-bold text-primary-600">0</span>
                    </div>
                    <button id="logoutBtn" class="text-gray-600 hover:text-primary-600">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome back, <span id="userDisplayName"></span>!</h2>
            <p class="text-gray-600">Here's your financial overview for this month</p>
        </div>

        <!-- Quick Stats -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
                <div class="text-3xl mb-2">üí∞</div>
                <h3 class="text-lg font-semibold text-gray-800">Total Income</h3>
                <div class="text-2xl font-bold text-green-600 number-container" id="statIncome">R 0</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">üí∏</div>
                <h3 class="text-lg font-semibold text-gray-800">Total Expenses</h3>
                <div class="text-2xl font-bold text-red-600 number-container" id="statExpenses">R 0</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">üéØ</div>
                <h3 class="text-lg font-semibold text-gray-800">Monthly Savings</h3>
                <div class="text-2xl font-bold text-primary-600 number-container" id="statSavings">R 0</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">‚≠ê</div>
                <h3 class="text-lg font-semibold text-gray-800">XP Points</h3>
                <div class="text-2xl font-bold text-accent-500" id="statXP">0</div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Savings Goal Progress -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Savings Goal Progress</h3>
                    <div id="savingsProgress">
                        <div class="text-center text-gray-500">
                            <p>No savings goal set yet</p>
                            <a href="/savings-goals" class="btn-primary mt-4">Set Your Goal</a>
                        </div>
                    </div>
                </div>

                <!-- Expense Breakdown -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Expense Breakdown</h3>
                    <div id="expenseBreakdown">
                        <div class="text-center text-gray-500">
                            <p>No expense data available</p>
                            <a href="/expenses" class="btn-primary mt-4">Add Expenses</a>
                        </div>
                    </div>
                </div>

                <!-- Monthly Reflection -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Monthly Reflection</h3>
                    <div id="monthlyReflection">
                        <div class="text-center text-gray-500">
                            <p>Complete your budget setup to see insights</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- XP Progress -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">XP Progress</h3>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Current Level</span>
                            <span class="text-sm font-medium text-gray-700" id="xpLevel">1</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="xpProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <span class="text-sm text-gray-600" id="xpProgressText">0 / 100 XP</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>Earn XP by staying on budget and meeting your savings goals!</p>
                    </div>
                </div>

                <!-- Rewards -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Rewards Center</h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-accent-500 to-accent-600 rounded-lg p-4 text-white">
                            <h4 class="font-semibold mb-2">Convert XP to Vouchers</h4>
                            <p class="text-sm mb-3">20 XP = 1 Voucher</p>
                            <div class="flex space-x-2">
                                <input type="number" id="xpToConvert" class="flex-1 px-3 py-2 rounded text-gray-800" placeholder="XP amount" min="20" step="20">
                                <button id="convertXP" class="bg-white text-accent-600 px-3 py-2 rounded font-semibold text-sm hover:bg-gray-100">
                                    Convert
                                </button>
                            </div>
                            <div id="conversionResult" class="mt-2 text-sm"></div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-primary-500 to-secondary-500 rounded-lg p-4 text-white">
                            <h4 class="font-semibold mb-2">Available Rewards</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>üéÅ R50 Gift Card</span>
                                    <span>100 XP</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üéÅ R100 Gift Card</span>
                                    <span>200 XP</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>üéÅ R250 Gift Card</span>
                                    <span>500 XP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <a href="/income" class="block w-full btn-secondary text-center">Update Income</a>
                        <a href="/savings-goals" class="block w-full btn-secondary text-center">Modify Goals</a>
                        <a href="/expenses" class="block w-full btn-secondary text-center">Edit Expenses</a>
                        <button id="refreshData" class="block w-full btn-primary">Refresh Data</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class DashboardManager {
            constructor() {
                this.userData = null;
                this.budgetData = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkAuthStatus();
                this.loadDashboardData();
            }

            setupEventListeners() {
                // XP conversion
                document.getElementById('convertXP').addEventListener('click', () => this.convertXP());
                
                // Refresh data
                document.getElementById('refreshData').addEventListener('click', () => this.loadDashboardData());
                
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            }

            async checkAuthStatus() {
                try {
                    const response = await fetch('/api/auth/me');
                    const data = await response.json();
                    
                    if (data.user) {
                        this.userData = data.user;
                        document.getElementById('userName').textContent = data.user.name;
                        document.getElementById('userDisplayName').textContent = data.user.name;
                    } else {
                        window.location.href = '/signup';
                    }
                } catch (error) {
                    console.error('Error checking auth status:', error);
                    window.location.href = '/signup';
                }
            }

            async loadDashboardData() {
                try {
                    const response = await fetch('/api/budget');
                    const data = await response.json();
                    
                    if (data.budgets && data.budgets.length > 0) {
                        this.budgetData = data.budgets[data.budgets.length - 1]; // Get latest budget
                        this.updateDashboard(data.budgets, data.totalXP);
                        this.loadMonthlyReflection();
                    } else {
                        this.showEmptyState();
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showError('Failed to load dashboard data');
                }
            }

            updateDashboard(budgets, totalXP) {
                const latestBudget = budgets[budgets.length - 1];
                
                // Update quick stats
                const totalIncome = latestBudget.income.primaryIncome + latestBudget.income.secondaryIncome + latestBudget.income.otherIncome;
                const totalExpenses = latestBudget.totals.total;
                const savings = totalIncome - totalExpenses;
                
                document.getElementById('statIncome').textContent = `R ${totalIncome.toLocaleString()}`;
                document.getElementById('statExpenses').textContent = `R ${totalExpenses.toLocaleString()}`;
                document.getElementById('statSavings').textContent = `R ${savings.toLocaleString()}`;
                document.getElementById('statXP').textContent = totalXP;
                document.getElementById('totalXP').textContent = totalXP;
                
                // Update XP progress
                this.updateXPProgress(totalXP);
                
                // Update savings progress
                this.updateSavingsProgress(latestBudget);
                
                // Update expense breakdown
                this.updateExpenseBreakdown(latestBudget);
            }

            updateXPProgress(totalXP) {
                const level = Math.floor(totalXP / 100) + 1;
                const progressInLevel = totalXP % 100;
                const progressPercentage = (progressInLevel / 100) * 100;
                
                document.getElementById('xpLevel').textContent = level;
                document.getElementById('xpProgressBar').style.width = `${progressPercentage}%`;
                document.getElementById('xpProgressText').textContent = `${progressInLevel} / 100 XP`;
            }

            updateSavingsProgress(budget) {
                const savingsData = budget.savings;
                const progressPercentage = Math.min((savingsData.monthlySavings / savingsData.targetAmount) * 100, 100);
                
                document.getElementById('savingsProgress').innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">${savingsData.category} Goal</span>
                            <span class="text-sm font-medium text-gray-700">${savingsData.duration} months</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-sm text-gray-600">
                            <span>R ${savingsData.monthlySavings.toLocaleString()}/month</span>
                            <span>R ${savingsData.targetAmount.toLocaleString()} target</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-primary-600">${progressPercentage.toFixed(1)}%</div>
                            <div class="text-sm text-gray-600">Progress</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600">${savingsData.duration}</div>
                            <div class="text-sm text-gray-600">Months</div>
                        </div>
                    </div>
                `;
            }

            updateExpenseBreakdown(budget) {
                const expenses = budget.totals;
                const total = expenses.total;
                
                const essentialPercentage = (expenses.essential / total) * 100;
                const entertainmentPercentage = (expenses.entertainment / total) * 100;
                const miscPercentage = (expenses.miscellaneous / total) * 100;
                
                document.getElementById('expenseBreakdown').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-red-500 rounded mr-3"></div>
                                <span class="text-sm font-medium">Essential</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">R ${expenses.essential.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">${essentialPercentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-blue-500 rounded mr-3"></div>
                                <span class="text-sm font-medium">Entertainment</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">R ${expenses.entertainment.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">${entertainmentPercentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-green-500 rounded mr-3"></div>
                                <span class="text-sm font-medium">Miscellaneous</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">R ${expenses.miscellaneous.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">${miscPercentage.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async loadMonthlyReflection() {
                try {
                    const response = await fetch('/api/reflection');
                    const reflection = await response.json();
                    
                    if (reflection.month) {
                        this.displayReflection(reflection);
                    }
                } catch (error) {
                    console.error('Error loading reflection:', error);
                }
            }

            displayReflection(reflection) {
                document.getElementById('monthlyReflection').innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">${reflection.month} Insights</h4>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-600">Savings Rate</div>
                                    <div class="font-semibold text-primary-600">${reflection.savingsRate}%</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">XP Earned</div>
                                    <div class="font-semibold text-accent-500">+${reflection.xpEarned}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h5 class="font-semibold text-gray-700">Key Insights</h5>
                        ${reflection.insights.map(insight => `
                            <div class="flex items-start space-x-2">
                                <span class="text-green-500 mt-1">‚úì</span>
                                <span class="text-sm text-gray-700">${insight}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${reflection.recommendations.length > 0 ? `
                        <div class="mt-4 space-y-3">
                            <h5 class="font-semibold text-gray-700">Recommendations</h5>
                            ${reflection.recommendations.map(rec => `
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-500 mt-1">üí°</span>
                                    <span class="text-sm text-gray-700">${rec}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }

            async convertXP() {
                const xpAmount = parseInt(document.getElementById('xpToConvert').value);
                
                if (!xpAmount || xpAmount < 20) {
                    this.showError('Please enter at least 20 XP to convert');
                    return;
                }
                
                if (xpAmount % 20 !== 0) {
                    this.showError('XP amount must be a multiple of 20');
                    return;
                }
                
                try {
                    const response = await fetch('/api/xp/convert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ xpAmount })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        document.getElementById('statXP').textContent = result.remainingXP;
                        document.getElementById('totalXP').textContent = result.remainingXP;
                        this.updateXPProgress(result.remainingXP);
                        
                        const resultDiv = document.getElementById('conversionResult');
                        resultDiv.innerHTML = `
                            <div class="bg-green-100 border border-green-400 text-green-700 px-3 py-2 rounded text-sm">
                                Success! You earned ${result.vouchersEarned} voucher(s)! üéÅ
                            </div>
                        `;
                        
                        document.getElementById('xpToConvert').value = '';
                    } else {
                        this.showError(result.message || 'Failed to convert XP');
                    }
                } catch (error) {
                    console.error('Error converting XP:', error);
                    this.showError('Network error. Please try again.');
                }
            }

            showEmptyState() {
                document.getElementById('savingsProgress').innerHTML = `
                    <div class="text-center text-gray-500">
                        <p>No savings goal set yet</p>
                        <a href="/savings-goals" class="btn-primary mt-4">Set Your Goal</a>
                    </div>
                `;
                
                document.getElementById('expenseBreakdown').innerHTML = `
                    <div class="text-center text-gray-500">
                        <p>No expense data available</p>
                        <a href="/expenses" class="btn-primary mt-4">Add Expenses</a>
                    </div>
                `;
            }

            async logout() {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/';
                } catch (error) {
                    console.error('Error logging out:', error);
                }
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 5000);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
    </script>
</body>
</html>
